#!/bin/bash

THIS_DIR="$(cd "$(dirname "$BASH_SOURCE")"; pwd)"
BASE_DIR="$(dirname $(dirname $THIS_DIR))"

. $BASE_DIR/lib/bash_include/config.bash
. $BASE_DIR/lib/bash_include/github.bash
. $BASE_DIR/lib/bash_include/bash_utils.bash

IMAGE_FULLNAME="$DOCKER_NAMESPACE/$PHUSION_BASE_IMAGE_NAME"

github_checkout "$PHUSION_BASE_IMAGE_REPO" "$PHUSION_BASE_IMAGE_SOURCE_DIR" "$PHUSION_BASE_IMAGE_REPO_RELEASE_TAG" || exit 1
cd "$PHUSION_BASE_IMAGE_SOURCE_DIR" || exit 1

export PATH="$BASE_DIR/lib/docker_shim:$PATH" # use a docker shim to filter out arguments we don't like

export PLATFORM=amd64 QEMU_ARCH=amd64 TAG_ARCH=amd64
MAKE_OUTPUT="$(make build BASE_IMAGE="$BASE_IMAGE" NAME="$IMAGE_FULLNAME" )" || exit_with_error_message "make build FAILED" # build

echo "$MAKE_OUTPUT"

TAG_REPORT="$(echo "$MAKE_OUTPUT" | grep "^Successfully tagged $IMAGE_FULLNAME:$PHUSION_BASE_IMAGE_VERSION\$")" || exit_with_error_message "Image not tagged as expected"

echo $TAG_REPORT > "$PHUSION_BASE_IMAGE_SOURCE_STATE_REPORT"
report_local_repository_state "$PHUSION_BASE_IMAGE_SOURCE_DIR" >> "$PHUSION_BASE_IMAGE_SOURCE_STATE_REPORT"
